<index.html> 
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Learning Language by Yourself</title>
  <style>
    body {
      background-image: url('assets/forest.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    html, body {
      margin: 0; padding: 0; overflow: hidden;
      font-family: 'Courier New', Courier, monospace;
      color: #fff;
      display: flex; justify-content: center; align-items: center; height: 100vh;
    }

    /* Container chính chứa toàn bộ game và quảng cáo */
    #main-container {
      display: flex;
      width: 100%;
      height: 100%;
      justify-content: center;
      align-items: center;
    }

    /* Quảng cáo banner hai bên */
    .ad-banner {
      width: 198px;
      height: 425px;
      margin: 0 20px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #444;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
      transition: transform 0.3s;
    }

    .ad-banner:hover {
      transform: scale(1.02);
    }

    .ad-banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }

    /* Quảng cáo full màn hình khi game over */
    #fullscreen-ad {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #ad-container {
      width: calc(95vh * (9 / 16));
      height: 95vh;
      max-width: 100vw;
      max-height: 100vh;
      background: #000;
      border: 3px solid #ffcc00;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    #ad-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #ad-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-weight: bold;
    }

    #ad-timer {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 18px;
    }

    .screen-overlay {
      position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200; text-align: center;
    }
    
    #start-screen { display: flex; }
    #input-screen { display: none; }

    button {
      padding: 12px 24px; margin: 8px; font-size: 18px; cursor: pointer;
      border: 2px solid #fff; background-color: rgba(40, 170, 220, 0.8); 
      color: #fff; border-radius: 8px; transition: all 0.2s;
      font-weight: bold;
    }
    button:hover { transform: scale(1.05); background-color: rgba(60, 190, 240, 1); }
    
    textarea {
      width: 300px; height: 200px; margin: 8px; font-size: 16px; padding: 8px;
      background: rgba(0,0,0,0.7); color: #fff; border: 1px solid #555; border-radius: 4px;
    }
    
    #game-wrapper {
        display: none; width: 100%; height: 100%;
        justify-content: center; align-items: center;
    }
    
    #game-ui-container {
        position: relative;
        width: calc(95vh * (9 / 16)); height: 95vh;
        max-width: 100vw; max-height: 100vh;
        border: 2px solid #444;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        background: transparent;
    }
    
    canvas {
      width: 100%; height: 100%; display: block; background: transparent;
    }
    
    #game-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      text-align: center;
    }
    
    #penguin-character {
        display: block;
        width: 90px;
        height: 100px;
        margin: 0 auto;
        margin-bottom: -15px;
        position: relative;
        z-index: 12;
    }
    
    #input-container {
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.5);
      box-sizing: border-box;
      border-top: 2px solid #444;
    }
    
    #answer-input {
      width: 90%; padding: 10px; font-size: 18px; border: 2px solid #555;
      border-radius: 4px; outline: none; color: #fff; background: #222;
    }
    
    #game-over {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 100;
    }
    
    .penguin-gif {
        width: 150px;
        height: auto;
        margin-bottom: 20px;
    }
    
    #victory-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: none; justify-content: center; align-items: center; flex-direction: column;
        z-index: 150; background: rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>

  <!-- Quảng cáo full màn hình -->
  <div id="fullscreen-ad">
    <div id="ad-container">
      <img id="ad-image" src="" alt="Quảng cáo">
      <button id="ad-close">X</button>
      <div id="ad-timer">Quảng cáo sẽ đóng sau: <span id="countdown">30</span> giây</div>
    </div>
  </div>

  <div id="main-container">
    <!-- Banner quảng cáo bên trái -->
    <div class="ad-banner" id="left-banner">
      <img src="" alt="Quảng cáo trái">
    </div>

    <!-- Phần game chính -->
    <div id="start-screen" class="screen-overlay">
      <h1>Learning Language by Yourself</h1>
      <img id="penguin-hi-start" class="penguin-gif" alt="Penguin Hi"/>
      <button id="btn-to-input">Bắt đầu</button>
    </div>

    <div id="input-screen" class="screen-overlay">
      <h2>Nhập Chướng ngại &amp; Đáp án</h2>
      <img id="penguin-hi-input" class="penguin-gif" alt="Penguin Hi"/>
      <div style="display: flex;">
        <div><label>Chướng ngại:</label><br /><textarea id="obstacles" placeholder="..."></textarea></div>
        <div><label>Đáp án:</label><br /><textarea id="answers" placeholder="..."></textarea></div>
      </div>
      <div>
        <button id="btn-clear">Xóa tất cả</button>
        <button id="btn-back">Quay lại</button>
        <button id="btn-confirm">Xác nhận & Chơi</button>
      </div>
    </div>

    <div id="game-wrapper">
      <div id="game-ui-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="game-controls">
          <img id="penguin-character" alt="Penguin Character"/>
          <div id="input-container">
            <input id="answer-input" type="text" placeholder="Gõ câu trả lời..." autocomplete="off"/>
          </div>
        </div>

        <div id="victory-screen">
          <img id="penguin-fun" class="penguin-gif" alt="Penguin Fun"/>
        </div>
        
        <div id="game-over" class="screen-overlay" style="display: none;">
          <img id="penguin-dead" class="penguin-gif" alt="Penguin Dead"/>
          <h2>GAME OVER</h2>
          <p id="final-score">Bạn đã đạt: 0 điểm</p>
          <div>
            <button id="play-again">Chơi lại</button>
            <button id="btn-back-to-input">Sửa chướng ngại</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Banner quảng cáo bên phải -->
    <div class="ad-banner" id="right-banner">
      <img src="" alt="Quảng cáo phải">
    </div>
  </div>

<script>
// =======================================================
// PHẦN QUẢNG CÁO - CẤU HÌNH URL ẢNH VÀ LIÊN KẾT
// =======================================================

// CẤU HÌNH QUẢNG CÁO - THAY ĐỔI CÁC URL DƯỚI ĐÂY
const AD_CONFIG = {
  leftBanner: {
    image: "assets/left-banner.png",    // Đường dẫn đến ảnh banner trái
    link: "https://nhà-quảng-cáo.com/trái" // URL khi click vào banner trái
  },
  rightBanner: {
    image: "assets/right-banner.png",   // Đường dẫn đến ảnh banner phải
    link: "https://nhà-quảng-cáo.com/phải" // URL khi click vào banner phải
  },
  fullscreenAd: {
    image: "assets/fullscreen-ad.jpg",  // Đường dẫn đến ảnh quảng cáo fullscreen
    link: "https://nhà-quảng-cáo.com/fullscreen" // URL khi click vào quảng cáo fullscreen
  }
};

// Thiết lập quảng cáo
function setupAds() {
  // Thiết lập banner trái
  const leftBanner = document.getElementById('left-banner');
  const leftBannerImg = leftBanner.querySelector('img');
  leftBannerImg.src = AD_CONFIG.leftBanner.image;
  leftBanner.addEventListener('click', () => {
    window.open(AD_CONFIG.leftBanner.link, '_blank');
  });

  // Thiết lập banner phải
  const rightBanner = document.getElementById('right-banner');
  const rightBannerImg = rightBanner.querySelector('img');
  rightBannerImg.src = AD_CONFIG.rightBanner.image;
  rightBanner.addEventListener('click', () => {
    window.open(AD_CONFIG.rightBanner.link, '_blank');
  });

  // Thiết lập quảng cáo full màn hình
  const adImage = document.getElementById('ad-image');
  adImage.src = AD_CONFIG.fullscreenAd.image;
  
  const adContainer = document.getElementById('ad-container');
  adContainer.addEventListener('click', (e) => {
    if (e.target.id !== 'ad-close') {
      window.open(AD_CONFIG.fullscreenAd.link, '_blank');
    }
  });

  // Nút đóng quảng cáo
  const adClose = document.getElementById('ad-close');
  adClose.addEventListener('click', closeFullscreenAd);
}

// Hiển thị quảng cáo full màn hình
function showFullscreenAd() {
  const fullscreenAd = document.getElementById('fullscreen-ad');
  fullscreenAd.style.display = 'flex';
  
  let countdown = 30;
  const countdownElement = document.getElementById('countdown');
  countdownElement.textContent = countdown;
  
  const timer = setInterval(() => {
    countdown--;
    countdownElement.textContent = countdown;
    
    if (countdown <= 0) {
      clearInterval(timer);
      closeFullscreenAd();
    }
  }, 1000);
  
  // Lưu timer để có thể clear khi cần
  window.adTimer = timer;
}

// Đóng quảng cáo full màn hình
function closeFullscreenAd() {
  const fullscreenAd = document.getElementById('fullscreen-ad');
  fullscreenAd.style.display = 'none';
  
  if (window.adTimer) {
    clearInterval(window.adTimer);
  }
}

// =======================================================
// PHẦN 0: ĐƠN GIẢN HÓA VIỆC TẢI ASSETS của lê đức anh
// =======================================================
const assetPaths = {
    hi: 'assets/penguinhi.gif',
    waiting: 'assets/penguinwaiting.gif',
    ping: 'assets/penguinping.gif',
    left: 'assets/penguinleft.gif',
    right: 'assets/penguinright.gif',
    fun: 'assets/penguinfun.gif',
    dead: 'assets/penguindead.gif',
    freezy: 'assets/freezy.png'
};

const freezyImage = new Image();
freezyImage.src = assetPaths.freezy;

function preloadImages() {
    document.getElementById('penguin-hi-start').src = assetPaths.hi;
    document.getElementById('penguin-hi-input').src = assetPaths.hi;
    document.getElementById('penguin-fun').src = assetPaths.fun;
    document.getElementById('penguin-dead').src = assetPaths.dead;
    document.getElementById('penguin-character').src = assetPaths.waiting;
}
preloadImages();

// =======================================================
// PHẦN 1: QUẢN LÝ GIAO DIỆN VÀ DOM ELEMENTS
// =======================================================
const startScreen = document.getElementById('start-screen');
const inputScreen = document.getElementById('input-screen');
const gameWrapper = document.getElementById('game-wrapper');
const btnToInput = document.getElementById('btn-to-input');
const btnConfirm = document.getElementById('btn-confirm');
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const inputBox = document.getElementById('answer-input');
const gameOverScreen = document.getElementById('game-over');
const finalScoreElement = document.getElementById('final-score');
const playAgainButton = document.getElementById('play-again');
const btnBackToInput = document.getElementById('btn-back-to-input');
const victoryScreen = document.getElementById('victory-screen');
const penguinCharacter = document.getElementById('penguin-character');

let userQuestions = [];
let userQuestionsIndex = 0;

btnToInput.addEventListener('click', () => { startScreen.style.display = 'none'; inputScreen.style.display = 'flex'; });
document.getElementById('btn-back').addEventListener('click', () => { inputScreen.style.display = 'none'; startScreen.style.display = 'flex'; });
document.getElementById('btn-clear').addEventListener('click', () => { document.getElementById('obstacles').value = ''; document.getElementById('answers').value = ''; });

btnConfirm.addEventListener('click', () => {
    const obstacles = document.getElementById('obstacles').value.trim().split('\n').filter(line => line);
    const answers = document.getElementById('answers').value.trim().split('\n').filter(line => line);
    if (obstacles.length === 0 || obstacles.length !== answers.length) {
        alert('Dữ liệu không hợp lệ. Vui lòng kiểm tra lại!'); return;
    }
    userQuestions = obstacles.map((q, i) => ({ question: q, answer: answers[i] }));
    inputScreen.style.display = 'none';
    startScreen.style.display = 'none';
    gameWrapper.style.display = 'flex';
    resize();
    startGame();
});

btnBackToInput.addEventListener('click', () => {
    gameOverScreen.style.display = 'none';
    gameWrapper.style.display = 'none';
    inputScreen.style.display = 'flex';
});

// =======================================================
// PHẦN 2: LOGIC GAME - ĐÃ SỬA LỖI
// =======================================================
function resize() {
  canvas.width = document.getElementById('game-ui-container').clientWidth;
  canvas.height = document.getElementById('game-ui-container').clientHeight;
}
window.addEventListener('resize', resize);

let gameRunning = false, score = 0, words = [], spawnTimer = 0;
const spawnInterval = 120;
let currentLevel = 1, wordsClearedThisLevel = 0, levelObjective = 0;
let wordsForCurrentLevel = [], baseSpeed = 0.3, spawnCount = 2;

let penguinStateTimer;
function setPenguinState(state) {
    clearTimeout(penguinStateTimer);
    penguinCharacter.src = assetPaths[state];
    if (state === 'left' || state === 'right' || state === 'ping') {
        penguinStateTimer = setTimeout(() => {
            penguinCharacter.src = assetPaths.waiting;
        }, 700);
    }
}

class Word {
  constructor(qObj) {
    this.text = qObj.question;
    this.answer = qObj.answer.trim().toLowerCase();
    this.x = Math.random() * (canvas.width * 0.8) + (canvas.width * 0.1);
    this.y = -50;
    this.speed = baseSpeed + Math.random() * (baseSpeed * 0.5);
    this.passed = false;
    this.width = canvas.width * 0.25;
    this.height = this.width * 0.6;
  }
  
  draw() {
    if (freezyImage.complete) {
        ctx.drawImage(freezyImage, this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
        ctx.fillStyle = '#FFFFFF';
        ctx.font = `bold ${this.height * 0.4}px 'Arial', sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.strokeText(this.text, this.x, this.y);
        ctx.fillText(this.text, this.x, this.y);
    }
  }
  
  update() {
    this.y += this.speed * (canvas.height / 800);
    if (this.y > document.getElementById('game-controls').offsetTop) {
      this.passed = true;
    }
  }
}

function showVictoryAndStartNextLevel() {
    gameRunning = false;
    setPenguinState('fun');
    victoryScreen.style.display = 'flex';
    setTimeout(() => {
        victoryScreen.style.display = 'none';
        startLevel(currentLevel + 1);
        gameRunning = true;
        loop();
    }, 2500);
}

function startLevel(levelNum) {
    setPenguinState('waiting');
    currentLevel = levelNum; 
    wordsClearedThisLevel = 0; 
    words = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    levelObjective = 10 + (currentLevel - 1);
    baseSpeed = 0.1 + (0.05 * (currentLevel - 1));
    spawnCount = 2 + (currentLevel - 1);
    
    wordsForCurrentLevel = [];
    for (let i = 0; i < levelObjective; i++) {
        if (userQuestionsIndex < userQuestions.length) {
            wordsForCurrentLevel.push(userQuestions[userQuestionsIndex++]);
        } else {
            userQuestionsIndex = 0; // Reset index khi hết câu hỏi
            wordsForCurrentLevel.push(userQuestions[userQuestionsIndex++]);
        }
    }
}

let animationFrameId;
function startGame() {
    // Reset tất cả biến quan trọng
    score = 0; 
    userQuestionsIndex = 0; 
    gameRunning = true;
    words = [];
    wordsForCurrentLevel = [];
    spawnTimer = 0;
    currentLevel = 1;
    
    gameOverScreen.style.display = 'none';
    inputBox.value = ''; 
    inputBox.focus();
    startLevel(1);

    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }
    loop();
}

function loop() {
  if (!gameRunning) {
      return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  spawnTimer++;
  if (spawnTimer >= spawnInterval && wordsForCurrentLevel.length > 0) {
    for (let i = 0; i < spawnCount; i++) {
        if (wordsForCurrentLevel.length > 0) words.push(new Word(wordsForCurrentLevel.shift()));
    }
    spawnTimer = 0;
  }
  
  for (let i = words.length - 1; i >= 0; i--) {
    const w = words[i]; 
    w.update(); 
    w.draw();
    if (w.passed) { 
        gameOver(); 
        return; 
    }
  }
  
  ctx.fillStyle = '#fff'; 
  ctx.font = `bold ${canvas.width * 0.05}px 'Courier New', monospace`;
  ctx.textAlign = 'left'; 
  ctx.fillText(`Màn: ${currentLevel}`, 15, canvas.height * 0.05);
  ctx.textAlign = 'right'; 
  ctx.fillText(`${wordsClearedThisLevel}/${levelObjective}`, canvas.width - 15, canvas.height * 0.05);
  
  animationFrameId = requestAnimationFrame(loop);
}

function gameOver() {
  gameRunning = false;
  setPenguinState('dead');
  finalScoreElement.textContent = `Bạn qua được Màn ${currentLevel-1}. Tổng điểm: ${score}`;
  gameOverScreen.style.display = 'flex';
  
  // Hiển thị quảng cáo full màn hình khi game over
  setTimeout(showFullscreenAd, 1000);
}

inputBox.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && gameRunning) {
    const val = inputBox.value.trim().toLowerCase();
    if (!val) return;
    let correctGuess = false;
    for (let i = 0; i < words.length; i++) {
      if (words[i].answer === val) {
        const targetWord = words[i];
        const penguinCenterX = penguinCharacter.offsetLeft + penguinCharacter.width / 2;
        
        if (targetWord.x < penguinCenterX) setPenguinState('left');
        else setPenguinState('right');
        
        words.splice(i, 1);
        score += 10;
        wordsClearedThisLevel++;
        correctGuess = true;
        
        if (wordsClearedThisLevel >= levelObjective) {
            showVictoryAndStartNextLevel();
        }
        break;
      }
    }
    if (!correctGuess) setPenguinState('ping');
    inputBox.value = '';
  }
});

playAgainButton.addEventListener('click', startGame);
window.addEventListener('click', () => { if (gameRunning) inputBox.focus(); });

// =======================================================
// PHẦN BẢO MẬT: CHỐNG DEBUG VÀ INSPECT (ĐÃ SỬA)
// =======================================================
(function() {
    // Chống mở DevTools
    function detectDevTools() {
        const widthThreshold = window.outerWidth - window.innerWidth > 160;
        const heightThreshold = window.outerHeight - window.innerHeight > 160;
        
        if (widthThreshold || heightThreshold) {
            document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:black;color:red;font-size:24px;">DevTools detected! Page will reload.</div>';
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    }
    
    // Vô hiệu hóa chuột phải
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Chặn phím tắt DevTools
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') || 
            (e.ctrlKey && e.key === 'u') ||
            (e.ctrlKey && e.shiftKey && e.key === 'C') ||
            (e.ctrlKey && e.key === 'R')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Kiểm tra thường xuyên
    setInterval(detectDevTools, 1000);
})();

// Khởi tạo quảng cáo khi trang được tải
window.addEventListener('load', function() {
  setupAds();
});
</script>
</body>
</html>
